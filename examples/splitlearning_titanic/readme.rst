Split Learning Titanic Example in FEDn
======================================

To run the commands, first git clone this repository and switch to the branch containing this code. 
In order to be able to run this example, you need to install FEDn in development mode. 
It is best if you create a virtual environment for this. 

.. code-block:: bash

    git clone https://github.com/fedn/fedn.git
    cd fedn
    pip install -e .


Also install the following libraries into your virtual environment:

.. code-block:: bash

    pip install pandas torch scikit-learn


Make sure a client.yaml file is available in the examples/splitlearning_titanic folder with the following content:

.. code-block:: bash
    network_id: fedn-network
    api_url: http://api-server:8092
    discover_host: api-server
    discover_port: 8092


Data Preparation
----------------

Make sure the titanic dataset is downloaded in the splitlearning_titanic/data folder with the files "labels.csv", "train.csv" and "test.csv".
Download the dataset from https://www.kaggle.com/competitions/titanic/data if necessary.

We split the dataset (vertical split) into 2 clients. For this, locate yourself in the examples/splitlearning_titanic/client folder and run:

.. code-block:: bash

    python3 data.py

Compute Package
---------------

Then, locate yourself into the examples/splitlearning_titanic folder. To create the compute package, run:

.. code-block:: bash

    fedn package create --path client

Note: For split learning, we do not need a seed model as for horizontal federated learning. 

Local Setup with FEDn
---------------------

Currently, Split Learning can only be run locally. To start all necessary services, locate yourself into the fedn/examples/splitlearning_titanic directory.
Then, run the following commands in different terminals:

To start mongo and minio

.. code-block:: bash

    docker compose up -d mongo minio

Now start the controller from another terminal:

.. code-block:: bash

    fedn controller start

We need to set some environment variables in order to let the system know where to find the data and labels. 
In another terminal (make sure to be located in the examples/splitlearning_titanic folder), set the compute package environment variable and start the controller.

.. code-block:: bash

    export FEDN_COMPUTE_PACKAGE_DIR=.
    fedn controller start

Now, we set the path to the labels.pt file in the client folder and start the combiner (from another terminal, again from the examples/splitlearning_titanic folder)

.. code-block:: bash

    export FEDN_LABELS_PATH=./client/data/clients/labels.pt
    fedn combiner start

Open 2 new client terminals and locate yourself into the splitlearning_titanic folder. As both clients should have access to their respective vertical dataset, 
the datapath should be set to the different data folders that are generated by the data.py script.  
To start the first client, run:

.. code-block:: bash

    export FEDN_DATA_PATH=./client/data/clients/1/titanic.pt 
    fedn client start --api-url http://localhost --api-port 8092 -in client.yaml --local-package

and to start the second client, run:

.. code-block:: bash

    export FEDN_DATA_PATH=./client/data/clients/2/titanic.pt 
    fedn client start --api-url http://localhost --api-port 8092 -in client.yaml --local-package


Starting the Split Learning Training
-------------------------------------

We are going to start the training through the API Client. 
Go to the api.ipynb file in the splitlearning_titanic folder and execute the cells. 
The splitlearning session should start running. 




